name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  # Job 1: Run tests first
  test:
    name: Test & Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Detect and run tests based on project type
      - name: Detect Project Type
        id: detect
        run: |
          if [ -f "package.json" ]; then
            echo "type=node" >> $GITHUB_OUTPUT
          elif [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            echo "type=python" >> $GITHUB_OUTPUT
          elif [ -f "go.mod" ]; then
            echo "type=go" >> $GITHUB_OUTPUT
          elif [ -f "Cargo.toml" ]; then
            echo "type=rust" >> $GITHUB_OUTPUT
          else
            echo "type=unknown" >> $GITHUB_OUTPUT
          fi

      # Node.js setup
      - name: Setup Bun
        if: steps.detect.outputs.type == 'node'
        uses: oven-sh/setup-bun@v1

      - name: Install Node Dependencies
        if: steps.detect.outputs.type == 'node'
        run: |
          if [ -f "bun.lockb" ]; then
            bun install
          elif [ -f "yarn.lock" ]; then
            yarn install
          else
            npm ci
          fi

      - name: Run Node Tests
        if: steps.detect.outputs.type == 'node'
        id: test-node
        run: |
          if [ -f "bun.lockb" ]; then
            bun test
          elif [ -f "yarn.lock" ]; then
            yarn test
          else
            npm test
          fi
        continue-on-error: true

      # Python setup
      - name: Setup Python
        if: steps.detect.outputs.type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python Dependencies
        if: steps.detect.outputs.type == 'python'
        run: |
          pip install -e .
          pip install pytest
        continue-on-error: true

      - name: Run Python Tests
        if: steps.detect.outputs.type == 'python'
        id: test-python
        run: pytest
        continue-on-error: true

      # Go setup
      - name: Setup Go
        if: steps.detect.outputs.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run Go Tests
        if: steps.detect.outputs.type == 'go'
        id: test-go
        run: go test ./...
        continue-on-error: true

      # Rust setup
      - name: Setup Rust
        if: steps.detect.outputs.type == 'rust'
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Run Rust Tests
        if: steps.detect.outputs.type == 'rust'
        id: test-rust
        run: cargo test
        continue-on-error: true

      - name: Check for failures
        id: check-failures
        run: |
          FAILED=""
          if [ "${{ steps.test-node.outcome }}" == "failure" ]; then
            FAILED="${FAILED}node-tests,"
          fi
          if [ "${{ steps.test-python.outcome }}" == "failure" ]; then
            FAILED="${FAILED}python-tests,"
          fi
          if [ "${{ steps.test-go.outcome }}" == "failure" ]; then
            FAILED="${FAILED}go-tests,"
          fi
          if [ "${{ steps.test-rust.outcome }}" == "failure" ]; then
            FAILED="${FAILED}rust-tests,"
          fi
          echo "failures=${FAILED}" >> $GITHUB_OUTPUT
          if [ -n "$FAILED" ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
          fi

    outputs:
      has_failures: ${{ steps.check-failures.outputs.has_failures }}
      failures: ${{ steps.check-failures.outputs.failures }}

  # Job 2: Claude review
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          additional_permissions: |
            actions: read
          claude_args: |
            --model claude-sonnet-4-20250514
            --max-turns 15
          prompt: |
            ## Code Review Task

            Review this PR for:

            ### 1. Code Quality
            - Bugs, logic errors, edge cases
            - Security vulnerabilities (injection, auth, data exposure)
            - Performance issues
            - Type safety issues

            ### 2. Vision Alignment
            Read `.vision/CONSTRAINTS.md` if it exists and verify changes align with project constraints.

            ### 3. Test Coverage
            - Check if changed files have corresponding tests
            - Flag missing tests as WARNING
            - Check test quality, not just existence

            ### 4. No Placeholders
            Search for: TODO, FIXME, HACK, XXX, PLACEHOLDER
            Flag any new instances.

            ### 5. CI/CD Failures
            ${{ needs.test.outputs.has_failures == 'true' && format('CI FAILURES DETECTED: {0}', needs.test.outputs.failures) || 'All tests passed.' }}

            ${{ needs.test.outputs.has_failures == 'true' && 'Identify root cause and suggest fixes.' || '' }}

            ### Output Format
            Provide structured feedback:
            - CRITICAL: Must fix before merge
            - WARNING: Should fix
            - SUGGESTION: Nice to have
